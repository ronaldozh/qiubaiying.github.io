---
layout:     post
title:      oracle常见操作
subtitle:   高级语句及常见问题解决
date:       2017-11-24
author:     赵小恒
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - oracle
---

### 1、oracle表与数据删除后的恢复

#### 1.1 表恢复

对误删的表，只要没有使用 purge 永久删除选项，那么基本上是能从 flashback table 区恢复回来的。oracle 10g 以上提供的功能。

**a.从 flashback table 里查询被删除的数据表**

```
select * from recyclebin order by droptime desc
```

**b.执行表的恢复**

```
flashback table 需要恢复的表名 to before drop
```

#### 1.2 表数据恢复

对误删的表记录，只要没有 truncate 语句，就可以根据事务的提交时间进行选择恢复。oracle 10g 以上提供的功能。

 **a. 先从 flashback_transaction_query 视图里查询，视图提供了供查询用的表名称、事务提交时间、undo_sql等字段。**
 
 ```
 select * from flashback_transaction_query where table_name='需要恢复数据的表名（大写）';
 ```
 
 **b.需要允许 oracle 修改分配给行的 rowid**
 
 ```
 alter table 需要恢复数据的表名 enable row movement;
 ```
 
 **c.恢复语句**
 
 ```
 flashback table 需要恢复数据的表名 to timestamp to_timestamp('数据丢失的前一时间点','yyyy-mm-dd hh24:mi:ss');
 ```

### 2、sql语句

#### 2.1 vm_concat实现字段合并
>oracle wm_concat(column)函数使我们经常会使用到的，使用oracle wm_concat(column)函数实现字段合并。

```
create table shopping(u_id  int,goods varchar2(100),num int);
insert into shopping values(1,'苹果',2);
insert into shopping values(2,'梨子',5);
insert into shopping values(1,'西瓜',4);
insert into shopping values(3,'葡萄',1);
insert into shopping values(3,'香蕉',1);
insert into shopping values(1,'橘子',3);
commit;
```

`想要的结果1:`

```
  U_ID   		GOODS_SUM
--------------  -----------------
	1    		苹果,西瓜,橘子
	2    		梨子
	3    		葡萄,香蕉
```
```
select u_id, wm_concat(goods || '(' || num || '斤)' ) goods_sum  from shopping  group by u_id ;
```

`想要的结果2:`

```
 U_ID       GOODS_SUM                                                                       
--------    --------------------------------
   1        苹果(2斤),西瓜(4斤),橘子(3斤)                                                   
   2        梨子(5斤)                                                                       
   3        葡萄(1斤),香蕉(1斤)  
```
```
select u_id, wm_concat(goods || '(' || num || '斤)' ) goods_sum  from shopping  group by u_id ;
```